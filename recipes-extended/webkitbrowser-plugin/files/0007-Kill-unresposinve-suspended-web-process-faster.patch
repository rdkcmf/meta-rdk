Date: Thu, 26 Aug 2021 22:26:13 +0000
From: 632c91c721722d90bca24862e647e437ed9918e3 Mon Sep 17 00:00:00 2001
Subject: Kill unresposinve suspended web process faster
Source: COMCAST
License: GPLV2
Upstream-Status: Pending
Signed-off-by: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>

---
 WebKitBrowser/HtmlApp.config               |  4 ++--
 WebKitBrowser/LightningApp.config          |  4 ++--
 WebKitBrowser/ResidentApp.config           |  4 ++--
 WebKitBrowser/SearchAndDiscoveryApp.config |  4 ++--
 WebKitBrowser/WebKitBrowser.config         |  4 ++--
 WebKitBrowser/WebKitImplementation.cpp     | 16 ++++++++++++++++
 6 files changed, 26 insertions(+), 10 deletions(-)

diff --git a/WebKitBrowser/HtmlApp.config b/WebKitBrowser/HtmlApp.config
index 248b7fa1..c2afb7ac 100644
--- a/WebKitBrowser/HtmlApp.config
+++ b/WebKitBrowser/HtmlApp.config
@@ -73,8 +73,8 @@ map()
     if(DEFINED PLUGIN_HTML_APP_SECURE)
         kv(secure ${PLUGIN_HTML_APP_SECURE})
     endif()
-    kv(watchdogchecktimeoutinseconds 30)
-    kv(watchdoghangthresholdtinseconds 180)
+    kv(watchdogchecktimeoutinseconds 10)
+    kv(watchdoghangthresholdtinseconds 60)
     kv(loadblankpageonsuspendenabled true)
 end()
 ans(configuration)
diff --git a/WebKitBrowser/LightningApp.config b/WebKitBrowser/LightningApp.config
index 74a207f1..97ccad66 100644
--- a/WebKitBrowser/LightningApp.config
+++ b/WebKitBrowser/LightningApp.config
@@ -73,8 +73,8 @@ map()
     if(DEFINED PLUGIN_LIGHTNING_APP_SECURE)
         kv(secure ${PLUGIN_LIGHTNING_APP_SECURE})
     endif()
-    kv(watchdogchecktimeoutinseconds 30)
-    kv(watchdoghangthresholdtinseconds 180)
+    kv(watchdogchecktimeoutinseconds 10)
+    kv(watchdoghangthresholdtinseconds 60)
     kv(loadblankpageonsuspendenabled true)
 end()
 ans(configuration)
diff --git a/WebKitBrowser/ResidentApp.config b/WebKitBrowser/ResidentApp.config
index 9eaaae43..cbc2621c 100644
--- a/WebKitBrowser/ResidentApp.config
+++ b/WebKitBrowser/ResidentApp.config
@@ -71,8 +71,8 @@ map()
     if(DEFINED PLUGIN_RESIDENT_APP_SECURE)
         kv(secure ${PLUGIN_RESIDENT_APP_SECURE})
     endif()
-    kv(watchdogchecktimeoutinseconds 30)
-    kv(watchdoghangthresholdtinseconds 180)
+    kv(watchdogchecktimeoutinseconds 10)
+    kv(watchdoghangthresholdtinseconds 60)
 end()
 ans(configuration)
 
diff --git a/WebKitBrowser/SearchAndDiscoveryApp.config b/WebKitBrowser/SearchAndDiscoveryApp.config
index 42ab70f1..ced58b33 100644
--- a/WebKitBrowser/SearchAndDiscoveryApp.config
+++ b/WebKitBrowser/SearchAndDiscoveryApp.config
@@ -70,8 +70,8 @@ map()
     if(DEFINED PLUGIN_SEARCH_AND_DISCOVERY_APP_SECURE)
         kv(secure ${PLUGIN_SEARCH_AND_DISCOVERY_APP_SECURE})
     endif()
-    kv(watchdogchecktimeoutinseconds 30)
-    kv(watchdoghangthresholdtinseconds 180)
+    kv(watchdogchecktimeoutinseconds 10)
+    kv(watchdoghangthresholdtinseconds 60)
 end()
 ans(configuration)
 
diff --git a/WebKitBrowser/WebKitBrowser.config b/WebKitBrowser/WebKitBrowser.config
index 610b197d..74915b5f 100644
--- a/WebKitBrowser/WebKitBrowser.config
+++ b/WebKitBrowser/WebKitBrowser.config
@@ -87,8 +87,8 @@ map()
     if(DEFINED PLUGIN_WEBKITBROWSER_SECURE)
         kv(secure ${PLUGIN_WEBKITBROWSER_SECURE})
     endif()
-    kv(watchdogchecktimeoutinseconds 30)
-    kv(watchdoghangthresholdtinseconds 180)
+    kv(watchdogchecktimeoutinseconds 10)
+    kv(watchdoghangthresholdtinseconds 60)
 end()
 ans(configuration)
 
diff --git a/WebKitBrowser/WebKitImplementation.cpp b/WebKitBrowser/WebKitImplementation.cpp
index 3fa689ca..40884e24 100644
--- a/WebKitBrowser/WebKitImplementation.cpp
+++ b/WebKitBrowser/WebKitImplementation.cpp
@@ -1911,6 +1911,8 @@ static GSourceFuncs _handlerIntervention =
 
                         TRACE_GLOBAL(Trace::Information, (_T("Internal Suspend Notification took %d mS."), static_cast<uint32_t>(Core::Time::Now().Ticks() - object->_time)));
 
+                        object->CheckWebProcess();
+
                         return FALSE;
                     },
                     this);
@@ -2440,6 +2442,20 @@ static GSourceFuncs _handlerIntervention =
                                             activeURL.c_str()));
             }
 
+            if (!isWebProcessResponsive && _state == PluginHost::IStateControl::SUSPENDED)
+            {
+                SYSLOG(Logging::Notification, (_T("Killing unresponsive suspended WebProcess, pid=%u, reply num=%d(max=%d), url=%s\n"),
+                                            webprocessPID, _unresponsiveReplyNum, kWebProcessUnresponsiveReplyDefaultLimit,
+                                            activeURL.c_str()));
+                Logging::DumpSystemFiles(webprocessPID);
+                if (syscall(__NR_tgkill, webprocessPID, webprocessPID, SIGFPE) == -1)
+                {
+                    SYSLOG(Trace::Error, (_T("tgkill failed, signal=%d process=%u errno=%d (%s)"), SIGFPE, webprocessPID, errno, strerror(errno)));
+                }
+                DeactivateBrowser(PluginHost::IShell::FAILURE);
+                return;
+            }
+
             if (_unresponsiveReplyNum == kWebProcessUnresponsiveReplyDefaultLimit)
             {
                 Logging::DumpSystemFiles(webprocessPID);

From 797f38e8a85f4c6b3e8f582d1f3f4879e17c3b72 Mon Sep 17 00:00:00 2001
From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Mon, 30 Aug 2021 12:18:25 +0000
Subject: [PATCH 2/2] Give time to handle SIGFPE

Signed-off-by: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
---
 WebKitBrowser/WebKitImplementation.cpp | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/WebKitBrowser/WebKitImplementation.cpp b/WebKitBrowser/WebKitImplementation.cpp
index 40884e24..e74b4b40 100644
--- a/WebKitBrowser/WebKitImplementation.cpp
+++ b/WebKitBrowser/WebKitImplementation.cpp
@@ -2447,12 +2447,19 @@ static GSourceFuncs _handlerIntervention =
                 SYSLOG(Logging::Notification, (_T("Killing unresponsive suspended WebProcess, pid=%u, reply num=%d(max=%d), url=%s\n"),
                                             webprocessPID, _unresponsiveReplyNum, kWebProcessUnresponsiveReplyDefaultLimit,
                                             activeURL.c_str()));
-                Logging::DumpSystemFiles(webprocessPID);
-                if (syscall(__NR_tgkill, webprocessPID, webprocessPID, SIGFPE) == -1)
+                if (_unresponsiveReplyNum <= kWebProcessUnresponsiveReplyDefaultLimit)
                 {
-                    SYSLOG(Trace::Error, (_T("tgkill failed, signal=%d process=%u errno=%d (%s)"), SIGFPE, webprocessPID, errno, strerror(errno)));
+                    _unresponsiveReplyNum = kWebProcessUnresponsiveReplyDefaultLimit;
+                    Logging::DumpSystemFiles(webprocessPID);
+                    if (syscall(__NR_tgkill, webprocessPID, webprocessPID, SIGFPE) == -1)
+                    {
+                        SYSLOG(Trace::Error, (_T("tgkill failed, signal=%d process=%u errno=%d (%s)"), SIGFPE, webprocessPID, errno, strerror(errno)));
+                    }
+                }
+                else
+                {
+                    DeactivateBrowser(PluginHost::IShell::FAILURE);
                 }
-                DeactivateBrowser(PluginHost::IShell::FAILURE);
                 return;
             }
 
